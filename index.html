<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio PWA - Vers√£o Aprimorada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
        
        .header { background: white; border-bottom: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 64px; }
        .logo { display: flex; align-items: center; font-size: 20px; font-weight: bold; color: #2563eb; }
        .status { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #10b981; }
        .status-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }
        
        .nav { background: white; border-bottom: 1px solid #e5e7eb; }
        .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; gap: 32px; }
        .nav-tab { padding: 16px 8px; border-bottom: 2px solid transparent; font-size: 14px; font-weight: 500; color: #6b7280; background: none; border-left: none; border-right: none; border-top: none; cursor: pointer; transition: all 0.2s; position: relative; }
        .nav-tab.active { border-bottom-color: #2563eb; color: #2563eb; }
        .nav-tab:hover:not(.active) { color: #374151; border-bottom-color: #d1d5db; }
        .nav-badge { position: absolute; top: 8px; right: -8px; background: #ef4444; color: white; font-size: 10px; border-radius: 10px; padding: 2px 6px; }
        
        .main { max-width: 1200px; margin: 0 auto; padding: 32px 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 32px; }
        .<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" href="icon-192.png">
title h1 { font-size: 28px; font-weight: bold; color: #111827; margin-bottom: 8px; }
        .title p { color: #6b7280; }
        .controls { display: flex; gap: 16px; }
        .btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; border: none; transition: all 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .kpi-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .kpi-content { flex: 1; }
        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .kpi-label { font-size: 14px; color: #6b7280; font-weight: 500; }
        .kpi-value { font-size: 32px; font-weight: bold; color: #111827; }
        .kpi-change { font-size: 14px; color: #10b981; margin-top: 8px; }
        .kpi-change.negative { color: #ef4444; }
        .kpi-icon { padding: 12px; border-radius: 50%; color: white; font-size: 24px; }
        .kpi-icon.green { background: #10b981; }
        .kpi-icon.blue { background: #2563eb; }
        .kpi-icon.orange { background: #f59e0b; }
        .kpi-icon.purple { background: #8b5cf6; }
        
        .insights-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 32px; }
        .insights-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; color: #111827; }
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; }
        .insight-item { text-align: center; }
        .insight-dot { width: 12px; height: 12px; border-radius: 50%; margin: 0 auto 10px; }
        .insight-dot.green { background: #10b981; }
        .insight-dot.orange { background: #f59e0b; }
        .insight-dot.red { background: #ef4444; }
        .insight-label { font-size: 14px; color: #6b7280; margin-bottom: 4px; }
        .insight-value { font-weight: 600; color: #111827; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .chart-card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .chart-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #111827; }
        .chart-container { position: relative; height: 300px; }
        
        .performance-section { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 32px; }
        .performance-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; }
        .performance-title h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; color: #111827; }
        .performance-title p { font-size: 14px; color: #6b7280; }
        .performance-controls { display: flex; gap: 16px; flex-wrap: wrap; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-label { font-size: 14px; font-weight: 500; color: #374151; }
        .period-buttons { display: flex; background: #f3f4f6; border-radius: 8px; padding: 4px; }
        .period-btn { padding: 8px 16px; border: none; background: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .period-btn.active { background: #2563eb; color: white; }
        .period-btn:not(.active) { color: #6b7280; }
        .select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; background: white; font-size: 14px; }
        .performance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin: 24px 0; }
        .performance-card { text-align: center; padding: 16px; background: #f8fafc; border-radius: 8px; }
        .performance-label { font-size: 12px; color: #6b7280; margin-bottom: 6px; }
        .performance-value { font-size: 20px; font-weight: bold; color: #10b981; margin-bottom: 4px; }
        .performance-value.negative { color: #ef4444; }
        
        /* Portfolio Cards */
        .portfolio-grid { display: grid; gap: 24px; }
        .portfolio-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .portfolio-header { padding: 20px; border-bottom: 1px solid #e5e7eb; }
        .portfolio-header-content { display: flex; justify-content: space-between; align-items: flex-start; }
        .portfolio-info h3 { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .portfolio-info p { font-size: 14px; color: #6b7280; }
        .portfolio-value { text-align: right; }
        .portfolio-total { font-size: 24px; font-weight: bold; color: #111827; }
        .portfolio-count { font-size: 14px; color: #6b7280; margin-top: 4px; }
        .investments-list { padding: 20px; }
        .investment-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; }
        .investment-item:last-child { border-bottom: none; }
        .investment-info { flex: 1; }
        .investment-name { font-weight: 500; color: #111827; margin-bottom: 2px; }
        .investment-details { font-size: 12px; color: #6b7280; }
        .investment-value { text-align: right; }
        .investment-amount { font-weight: 600; color: #111827; }
        .investment-return { font-size: 12px; color: #10b981; margin-top: 2px; }
        .investment-return.negative { color: #ef4444; }
        .investment-actions { display: flex; gap: 8px; margin-left: 16px; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        
        /* Edit Mode */
        .investment-item.editing { background: #f3f4f6; padding: 16px; border-radius: 8px; margin: 8px 0; }
        .edit-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
        .edit-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
        
        /* Complete Data Styles */
        .complete-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
        .complete-title { font-size: 24px; font-weight: bold; color: #111827; }
        .complete-info { background: #dbeafe; padding: 20px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid #3b82f6; }
        .complete-info-title { font-size: 16px; font-weight: 600; color: #1e40af; margin-bottom: 8px; }
        .incomplete-list { display: grid; gap: 20px; }
        .incomplete-item { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); overflow: hidden; }
        .incomplete-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start; }
        .incomplete-info h4 { font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .incomplete-info .portfolio-name { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
        .missing-fields { font-size: 12px; color: #dc2626; }
        .incomplete-form { padding: 20px; display: none; }
        .incomplete-form.active { display: block; }
        
        /* Form Styles */
        .form-section { background: white; padding: 32px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .form-header { margin-bottom: 24px; }
        .form-header h2 { font-size: 24px; font-weight: bold; color: #111827; margin-bottom: 8px; }
        .form-header p { color: #6b7280; }
        .asset-type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }
        .asset-type-card { padding: 20px; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .asset-type-card:hover { border-color: #3b82f6; transform: translateY(-2px); }
        .asset-type-card.selected { border-color: #3b82f6; background: #eff6ff; }
        .asset-type-icon { font-size: 40px; margin-bottom: 12px; }
        .asset-type-title { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 4px; }
        .asset-type-desc { font-size: 14px; color: #6b7280; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .form-group { }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px; }
        .form-label .required { color: #ef4444; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; transition: all 0.2s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; padding-top: 24px; border-top: 1px solid #e5e7eb; }
        .custom-liquidity { margin-top: 12px; display: none; }
        .custom-liquidity.active { display: block; }
        .btn-save { background: #10b981; color: white; }
        .btn-save:hover { background: #059669; }
        .btn-skip { background: #6b7280; color: white; }
        .btn-skip:hover { background: #4b5563; }
        
        /* Rates Update Section */
        .rates-update-section { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
        .rates-update-btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 12px; }
        .rates-source { font-size: 12px; color: #6b7280; }
        .spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .notification { position: fixed; top: 20px; right: 20px; background: #dcfce7; border-left: 4px solid #16a34a; color: #15803d; padding: 16px 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1000; max-width: 400px; transform: translateX(450px); opacity: 0; transition: all 0.4s; }
        .notification.show { transform: translateX(0); opacity: 1; }
        .notification.error { background: #fee2e2; border-left-color: #dc2626; color: #991b1b; }
        .notification.warning { background: #fef3c7; border-left-color: #f59e0b; color: #92400e; }
        .notification-content { display: flex; align-items: center; justify-content: space-between; }
        .notification-close { margin-left: 16px; background: none; border: none; color: #6b7280; cursor: pointer; font-size: 18px; }
        
        .hidden { display: none; }
        
        /* Fund Quotes Section */
        .fund-quotes-section { background: #f3f4f6; padding: 16px; border-radius: 8px; margin-top: 20px; }
        .fund-quotes-title { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .fund-quotes-list { font-size: 12px; color: #6b7280; }
        .fund-quote-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .fund-quote-value { font-weight: 600; color: #111827; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .performance-header { flex-direction: column; align-items: stretch; }
            .performance-controls { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .asset-type-selector { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üíº Portfolio PWA</div>
            <div class="status">
                <span>v2.0</span>
                <div class="status-dot"></div>
                <span>Online</span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('portfolios')">üíº Carteiras</button>
            <button class="nav-tab" onclick="showTab('complete')">‚ö†Ô∏è Completar Dados<span class="nav-badge" id="incompleteBadge">6</span></button>
            <button class="nav-tab" onclick="showTab('add')">‚ûï Adicionar</button>
            <button class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è Configura√ß√µes</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="title">
                    <h1>Portfolio Dashboard</h1>
                    <p>CDI: <strong id="cdi-rate">11.65% a.a.</strong> ‚Ä¢ CDI Anual: <strong id="cdi-annual">11.65% a.a.</strong> ‚Ä¢ IPCA: <strong id="ipca-rate">4.82% a.a.</strong></p>
                    <div class="rates-update-section">
                        <button class="btn btn-secondary rates-update-btn" onclick="updateMarketRates()">
                            <span id="rates-update-icon">üîÑ</span>
                            <span>Atualizar Taxas</span>
                        </button>
                        <span class="rates-source">Fonte: investidor10.com.br/indices/</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" onclick="toggleValues()">
                        <span id="toggle-icon">üôà</span>
                        <span id="toggle-text">Ocultar</span> Valores
                    </button>
                    <button class="btn btn-primary" onclick="updateFundQuotes()">
                        üîÑ Atualizar Cotas
                    </button>
                </div>
            </div>

            <!-- KPIs de Mercado -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <div class="kpi-label">CDI</div>
                        </div>
                        <div class="kpi-value" id="cdi-display">11,65%</div>
                        <div class="kpi-change" id="cdi-change">üìä InfoMoney</div>
                    </div>
                    <div class="kpi-icon green">üí∞</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <div class="kpi-label">CDI Anualizado</div>
                        </div>
                        <div class="kpi-value" id="cdi-annual-display">11,65%</div>
                        <div class="kpi-change" id="cdi-annual-change">üìä Calculado</div>
                    </div>
                    <div class="kpi-icon blue">üìà</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <div class="kpi-label">IPCA (12m)</div>
                        </div>
                        <div class="kpi-value" id="ipca-display">4,82%</div>
                        <div class="kpi-change" id="ipca-change">üìä IBGE</div>
                    </div>
                    <div class="kpi-icon orange">üìä</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-header">
                            <div class="kpi-label">IBOVESPA</div>
                        </div>
                        <div class="kpi-value" id="ibov-display">128.500</div>
                        <div class="kpi-change" id="ibov-change">üìà +0.022% (B3)</div>
                    </div>
                    <div class="kpi-icon purple">üìä</div>
                </div>
            </div>

            <!-- Insights Inteligentes -->
            <div class="insights-card">
                <h3 class="insights-title">üîî Insights Inteligentes</h3>
                <div class="insights-grid">
                    <div class="insight-item">
                        <div class="insight-dot orange"></div>
                        <div class="insight-label">Liquidez Imediata</div>
                        <div class="insight-value" id="liquidity-immediate">8.2%</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-dot green"></div>
                        <div class="insight-label">Concentra√ß√£o RF</div>
                        <div class="insight-value" id="concentration-rf">78.5%</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-dot green"></div>
                        <div class="insight-label">Diversifica√ß√£o</div>
                        <div class="insight-value" id="diversification">3 institui√ß√µes</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-dot green"></div>
                        <div class="insight-label">Sharpe Simulado</div>
                        <div class="insight-value" id="sharpe-ratio">1.24</div>
                    </div>
                    <div class="insight-item">
                        <div class="insight-dot red"></div>
                        <div class="insight-label">Fundos Ativos</div>
                        <div class="insight-value" id="active-funds">0</div>
                    </div>
                </div>
            </div>

            <!-- Fund Quotes Section -->
            <div class="fund-quotes-section" id="fundQuotesSection" style="display: none;">
                <div class="fund-quotes-title">üíπ Cota√ß√µes de Fundos Atualizadas</div>
                <div class="fund-quotes-list" id="fundQuotesList"></div>
            </div>

            <!-- Gr√°ficos FUNCIONAIS -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Aloca√ß√£o por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Distribui√ß√£o por Liquidez</h3>
                    <div class="chart-container">
                        <canvas id="liquidityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance vs Benchmarks -->
            <div class="performance-section">
                <div class="performance-header">
                    <div class="performance-title">
                        <h3>Performance vs Benchmarks</h3>
                        <p>Carteira <span id="portfolio-display">Consolidada</span> - √öltimos <span id="period-display">12</span> meses</p>
                    </div>
                    <div class="performance-controls">
                        <div class="control-group">
                            <div class="control-label">Per√≠odo:</div>
                            <div class="period-buttons">
                                <button class="period-btn" onclick="setPeriod(6, this)">6m</button>
                                <button class="period-btn active" onclick="setPeriod(12, this)">12m</button>
                                <button class="period-btn" onclick="setPeriod(24, this)">24m</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-label">Carteira:</div>
                            <select class="select" onchange="setPortfolio(this.value)">
                                <option value="consolidated">üè¶ Consolidada</option>
                                <option value="brb">BRB (Conservadora)</option>
                                <option value="btg">BTG Pactual</option>
                                <option value="bb">Banco do Brasil (Agressiva)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Performance Cards -->
                <div class="performance-grid">
                    <div class="performance-card">
                        <div class="performance-label">Portfolio</div>
                        <div class="performance-value" id="portfolio-perf">+9.5%</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-label">CDI</div>
                        <div class="performance-value" id="cdi-perf">+8.4%</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-label">IBOVESPA</div>
                        <div class="performance-value" id="ibov-perf">+11.5%</div>
                    </div>
                    <div class="performance-card">
                        <div class="performance-label">IPCA</div>
                        <div class="performance-value" id="ipca-perf">+2.8%</div>
                    </div>
                </div>

                <!-- Line Chart -->
                <div class="chart-container" style="height: 400px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Portfolios Tab -->
        <div id="portfolios" class="tab-content">
            <h2 style="margin-bottom: 24px; color: #111827;">üíº Carteiras de Investimentos</h2>
            <div class="portfolio-grid" id="portfoliosList">
                <!-- Portfolios will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Complete Data Tab -->
        <div id="complete" class="tab-content">
            <div class="complete-header">
                <div style="font-size: 28px;">‚ö†Ô∏è</div>
                <div class="complete-title">Completar Dados Faltantes</div>
            </div>
            
            <div class="complete-info">
                <div class="complete-info-title">‚úÖ Sistema de Dados Aprimorado</div>
                <div style="font-size: 14px; color: #1e40af; line-height: 1.6;">
                    Sistema atualizado com suporte completo para fundos de investimento.<br/>
                    Complete os dados para an√°lises mais precisas e acompanhamento de cotas.
                </div>
            </div>
            
            <div class="incomplete-list" id="incompleteList">
                <!-- Incomplete investments will be inserted here by JavaScript -->
            </div>
        </div>

        <!-- Add Tab -->
        <div id="add" class="tab-content">
            <div class="form-section">
                <div class="form-header">
                    <h2>‚ûï Adicionar Novo Investimento</h2>
                    <p>Preencha os dados do seu investimento para adicionar √† carteira</p>
                </div>

                <!-- Asset Type Selection -->
                <div class="asset-type-selector">
                    <div class="asset-type-card" id="type-titulo" onclick="selectAssetType('titulo')">
                        <div class="asset-type-icon">üìÑ</div>
                        <div class="asset-type-title">T√≠tulo de Renda Fixa</div>
                        <div class="asset-type-desc">CDB, LCI, LCA, Tesouro, Deb√™ntures</div>
                    </div>
                    <div class="asset-type-card" id="type-fundo" onclick="selectAssetType('fundo')">
                        <div class="asset-type-icon">üíπ</div>
                        <div class="asset-type-title">Fundo de Investimento</div>
                        <div class="asset-type-desc">Multimercado, A√ß√µes, FII, ETF</div>
                    </div>
                </div>

                <!-- Dynamic Form -->
                <div id="investment-form" style="display: none;">
                    <!-- Form content will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div style="text-align: center; padding: 80px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px;">‚öôÔ∏è</div>
                <div style="font-size: 20px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">Configura√ß√µes</div>
                <div style="color: #9ca3af;">Backup, prefer√™ncias e configura√ß√µes avan√ßadas</div>
            </div>
        </div>
    </main>

    <!-- Notification System -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notif-text"></span>
            <button class="notification-close" onclick="hideNotification()">√ó</button>
        </div>
    </div>

    <script>
        // Portfolio Data - Enhanced with fund support
        let portfoliosData = [
            {
                id: 1, name: 'BRB - Banco de Bras√≠lia', institution: 'BRB', color: '#22c55e',
                investments: [
                    { id: '000002', name: 'CDB POS', category: 'RF', type: 'titulo', currentValue: 15000, acquisitionValue: 14500, monthlyReturn: null, yearlyReturn: null, acquisitionDate: null, contractedRate: null, issuer: null, liquidity: null },
                    { id: '000001', name: 'CDB POS', category: 'RF', type: 'titulo', currentValue: 25000, acquisitionValue: 24000, monthlyReturn: 0.95, yearlyReturn: 12.1, acquisitionDate: null, contractedRate: null, issuer: 'BRB', liquidity: 'D+1' },
                    { id: 'LCI001', name: 'LCI 98% CDI', category: 'RF', type: 'titulo', currentValue: 18000, acquisitionValue: 17500, monthlyReturn: 0.89, yearlyReturn: 11.5, acquisitionDate: null, contractedRate: 9.8, issuer: null, liquidity: null }
                ]
            },
            {
                id: 2, name: 'BTG Pactual', institution: 'BTG', color: '#3b82f6',
                investments: [
                    { id: 'CC001', name: 'Conta Compromissada', category: 'RF', type: 'titulo', currentValue: 22000, acquisitionValue: 21800, monthlyReturn: 1.02, yearlyReturn: 12.8, acquisitionDate: null, contractedRate: 12.25, issuer: 'BTG Pactual', liquidity: 'D+0' },
                    { id: 'LCD001', name: 'Legacy Compound Debt', category: 'RF', type: 'titulo', currentValue: 8500, acquisitionValue: 8200, monthlyReturn: 0.78, yearlyReturn: 9.8, acquisitionDate: '2024-03-15', contractedRate: 9.5, issuer: null, liquidity: 'D+90' }
                ]
            },
            {
                id: 3, name: 'Banco do Brasil', institution: 'BB', color: '#f59e0b',
                investments: [
                    { id: 'IBOV001', name: 'A√ß√µes Ibovespa', category: 'AV', type: 'titulo', currentValue: 35000, acquisitionValue: 32000, monthlyReturn: null, yearlyReturn: null, acquisitionDate: null, contractedRate: null, issuer: null, liquidity: null },
                    { id: 'RFLP001', name: 'RF LP High', category: 'RF', type: 'titulo', currentValue: 28000, acquisitionValue: 26500, monthlyReturn: null, yearlyReturn: null, acquisitionDate: '2023-12-10', contractedRate: 13.5, issuer: 'BB Asset', liquidity: 'D+360' }
                ]
            }
        ];

        // Market rates
        let marketRates = {
            cdi: 11.65,
            cdiAnnual: 11.65,
            ipca: 4.82,
            ibov: 128500,
            lastUpdate: new Date().toLocaleString('pt-BR')
        };

        // Performance data
        const performanceData = {
            6: { 
                consolidated: { portfolio: 4.8, cdi: 4.2, ibov: 6.1, ipca: 1.4 },
                brb: { portfolio: 4.1, cdi: 4.2, ibov: 6.1, ipca: 1.4 },
                btg: { portfolio: 5.2, cdi: 4.2, ibov: 6.1, ipca: 1.4 },
                bb: { portfolio: 5.8, cdi: 4.2, ibov: 6.1, ipca: 1.4 }
            },
            12: { 
                consolidated: { portfolio: 9.5, cdi: 8.4, ibov: 11.5, ipca: 2.8 },
                brb: { portfolio: 8.1, cdi: 8.4, ibov: 11.5, ipca: 2.8 },
                btg: { portfolio: 10.2, cdi: 8.4, ibov: 11.5, ipca: 2.8 },
                bb: { portfolio: 11.8, cdi: 8.4, ibov: 11.5, ipca: 2.8 }
            },
            24: { 
                consolidated: { portfolio: 18.2, cdi: 16.8, ibov: 22.3, ipca: 5.6 },
                brb: { portfolio: 15.4, cdi: 16.8, ibov: 22.3, ipca: 5.6 },
                btg: { portfolio: 19.1, cdi: 16.8, ibov: 22.3, ipca: 5.6 },
                bb: { portfolio: 22.8, cdi: 16.8, ibov: 22.3, ipca: 5.6 }
            }
        };
        
        const portfolioNames = {
            consolidated: 'Consolidada',
            brb: 'BRB (Conservadora)',
            btg: 'BTG Pactual',
            bb: 'Banco do Brasil (Agressiva)'
        };
        
        let currentPeriod = 12;
        let currentPortfolio = 'consolidated';
        let showValuesState = true;
        let allocationChart, liquidityChart, performanceChart;
        let currentAssetType = null;
        let editingInvestment = null;

        // Initialize charts
        function initCharts() {
            // Allocation Chart
            const allocationCtx = document.getElementById('allocationChart').getContext('2d');
            allocationChart = new Chart(allocationCtx, {
                type: 'pie',
                data: {
                    labels: ['Renda Fixa', 'A√ß√µes/Vari√°vel', 'Fundos'],
                    datasets: [{
                        data: [78.5, 18.2, 3.3],
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Liquidity Chart  
            const liquidityCtx = document.getElementById('liquidityChart').getContext('2d');
            liquidityChart = new Chart(liquidityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Liquidez Imediata', '30-90 dias', '1+ anos'],
                    datasets: [{
                        data: [8.2, 31.8, 60.0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Performance Chart
            updatePerformanceChart();
        }

        function updatePerformanceChart() {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'].slice(-currentPeriod);
            const data = performanceData[currentPeriod][currentPortfolio];
            
            // Generate sample monthly data
            const portfolioData = [];
            const cdiData = [];
            const ibovData = [];
            const ipcaData = [];
            
            for (let i = 0; i < currentPeriod; i++) {
                portfolioData.push((data.portfolio / currentPeriod) * (i + 1) + (Math.random() - 0.5) * 2);
                cdiData.push((data.cdi / currentPeriod) * (i + 1));
                ibovData.push((data.ibov / currentPeriod) * (i + 1) + (Math.random() - 0.5) * 4);
                ipcaData.push((data.ipca / currentPeriod) * (i + 1));
            }

            if (performanceChart) {
                performanceChart.destroy();
            }

            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: portfolioNames[currentPortfolio],
                        data: portfolioData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4
                    }, {
                        label: 'CDI',
                        data: cdiData,
                        borderColor: '#10b981',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'IBOVESPA',
                        data: ibovData,
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'IPCA',
                        data: ipcaData,
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Retorno Acumulado (%)'
                            }
                        }
                    }
                }
            });
        }

        // Update market rates with proper sources
        function updateMarketRates() {
            const icon = document.getElementById('rates-update-icon');
            icon.innerHTML = '<span class="spinner"></span>';
            
            // Simulate API call to investidor10.com.br/indices/
            setTimeout(() => {
                // Updated rates with corrected values
                marketRates = {
                    cdi: 11.65,
                    cdiAnnual: 12.16, // CDI anualizado corrigido
                    ipca: 4.89, // IPCA atualizado
                    ibov: 129234,
                    lastUpdate: new Date().toLocaleString('pt-BR')
                };
                
                // Update display
                document.getElementById('cdi-rate').textContent = `${marketRates.cdi}% a.a.`;
                document.getElementById('cdi-annual').textContent = `${marketRates.cdiAnnual}% a.a.`;
                document.getElementById('ipca-rate').textContent = `${marketRates.ipca}% a.a.`;
                document.getElementById('cdi-display').textContent = `${marketRates.cdi.toFixed(2).replace('.', ',')}%`;
                document.getElementById('cdi-annual-display').textContent = `${marketRates.cdiAnnual.toFixed(2).replace('.', ',')}%`;
                document.getElementById('ipca-display').textContent = `${marketRates.ipca.toFixed(2).replace('.', ',')}%`;
                document.getElementById('ibov-display').textContent = marketRates.ibov.toLocaleString('pt-BR');
                
                icon.innerHTML = 'üîÑ';
                showNotification('‚úÖ Taxas atualizadas com sucesso!');
            }, 2000);
        }

        // Update fund quotes
        function updateFundQuotes() {
            const funds = [];
            portfoliosData.forEach(portfolio => {
                portfolio.investments.forEach(inv => {
                    if (inv.type === 'fundo' && inv.cnpj) {
                        funds.push({ ...inv, portfolioId: portfolio.id });
                    }
                });
            });

            if (funds.length === 0) {
                showNotification('‚ÑπÔ∏è Nenhum fundo cadastrado para atualizar cotas', 'warning');
                return;
            }

            showNotification('üîÑ Atualizando cota√ß√µes de fundos...');

            // Simulate fund quote updates
            setTimeout(() => {
                const quotesSection = document.getElementById('fundQuotesSection');
                const quotesList = document.getElementById('fundQuotesList');
                quotesList.innerHTML = '';

                funds.forEach(fund => {
                    // Simulate quote update
                    const oldQuote = fund.currentQuote || 100;
                    const variation = (Math.random() - 0.5) * 5; // -2.5% to +2.5%
                    const newQuote = oldQuote * (1 + variation / 100);
                    
                    fund.currentQuote = newQuote;
                    fund.lastQuoteUpdate = new Date().toLocaleString('pt-BR');

                    const quoteItem = document.createElement('div');
                    quoteItem.className = 'fund-quote-item';
                    quoteItem.innerHTML = `
                        <span>${fund.name}</span>
                        <span class="fund-quote-value">R$ ${newQuote.toFixed(4)}</span>
                    `;
                    quotesList.appendChild(quoteItem);
                });

                quotesSection.style.display = 'block';
                showNotification('‚úÖ Cota√ß√µes atualizadas com sucesso!');
            }, 2000);
        }

        // Generate portfolios list with edit functionality
        function generatePortfoliosList() {
            const container = document.getElementById('portfoliosList');
            container.innerHTML = '';

            portfoliosData.forEach(portfolio => {
                const totalValue = portfolio.investments.reduce((sum, inv) => sum + inv.currentValue, 0);

                const portfolioCard = document.createElement('div');
                portfolioCard.className = 'portfolio-card';
                portfolioCard.innerHTML = `
                    <div class="portfolio-header">
                        <div class="portfolio-header-content">
                            <div class="portfolio-info">
                                <h3>${portfolio.name}</h3>
                                <p>Institui√ß√£o: ${portfolio.institution}</p>
                            </div>
                            <div class="portfolio-value">
                                <div class="portfolio-total">R$ ${totalValue.toLocaleString('pt-BR')}</div>
                                <div class="portfolio-count">${portfolio.investments.length} investimentos</div>
                            </div>
                        </div>
                    </div>
                    <div class="investments-list" id="portfolio-${portfolio.id}-investments">
                        ${generateInvestmentsList(portfolio)}
                    </div>
                `;
                container.appendChild(portfolioCard);
            });
        }

        function generateInvestmentsList(portfolio) {
            return portfolio.investments.map((investment, index) => {
                if (editingInvestment && editingInvestment.id === investment.id) {
                    return generateEditForm(investment, portfolio.id, index);
                } else {
                    return `
                        <div class="investment-item" id="investment-${investment.id}">
                            <div class="investment-info">
                                <div class="investment-name">${investment.name}</div>
                                <div class="investment-details">
                                    ${investment.category} ‚Ä¢ ${investment.id}
                                    ${investment.type === 'fundo' ? ' ‚Ä¢ Fundo' : ''}
                                    ${investment.liquidity ? ` ‚Ä¢ ${investment.liquidity}` : ''}
                                </div>
                            </div>
                            <div class="investment-value">
                                <div class="investment-amount">R$ ${investment.currentValue.toLocaleString('pt-BR')}</div>
                                <div class="investment-return ${investment.yearlyReturn && investment.yearlyReturn < 0 ? 'negative' : ''}">
                                    ${investment.yearlyReturn ? `${investment.yearlyReturn > 0 ? '+' : ''}${investment.yearlyReturn}%` : 'N/D'}
                                </div>
                            </div>
                            <div class="investment-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editInvestment('${investment.id}', ${portfolio.id})">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function generateEditForm(investment, portfolioId, index) {
            return `
                <div class="investment-item editing">
                    <div style="width: 100%;">
                        <h4 style="margin-bottom: 12px;">Editando: ${investment.name}</h4>
                        <div class="edit-grid">
                            <div class="form-group">
                                <label class="form-label">Nome</label>
                                <input type="text" class="form-input" id="edit-name" value="${investment.name}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor Atual</label>
                                <input type="number" class="form-input" id="edit-currentValue" value="${investment.currentValue}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Valor Investido</label>
                                <input type="number" class="form-input" id="edit-acquisitionValue" value="${investment.acquisitionValue}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Liquidez</label>
                                <select class="form-select" id="edit-liquidity" onchange="handleEditLiquidityChange()">
                                    <option value="">Selecione</option>
                                    <option value="D+0" ${investment.liquidity === 'D+0' ? 'selected' : ''}>D+0</option>
                                    <option value="D+1" ${investment.liquidity === 'D+1' ? 'selected' : ''}>D+1</option>
                                    <option value="D+30" ${investment.liquidity === 'D+30' ? 'selected' : ''}>D+30</option>
                                    <option value="D+60" ${investment.liquidity === 'D+60' ? 'selected' : ''}>D+60</option>
                                    <option value="D+90" ${investment.liquidity === 'D+90' ? 'selected' : ''}>D+90</option>
                                    <option value="custom">Customizar...</option>
                                </select>
                                <div class="custom-liquidity" id="edit-custom-liquidity" style="${investment.liquidity && !['D+0','D+1','D+30','D+60','D+90'].includes(investment.liquidity) ? 'display:block;' : ''}">
                                    <input type="text" class="form-input" id="edit-liquidity-custom" placeholder="Ex: D+180" value="${investment.liquidity || ''}">
                                </div>
                            </div>
                            ${investment.type === 'fundo' ? `
                                <div class="form-group">
                                    <label class="form-label">CNPJ do Fundo</label>
                                    <input type="text" class="form-input" id="edit-cnpj" value="${investment.cnpj || ''}" placeholder="00.000.000/0000-00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Taxa Admin (%)</label>
                                    <input type="number" step="0.01" class="form-input" id="edit-adminFee" value="${investment.adminFee || ''}" placeholder="2.00">
                                </div>
                            ` : `
                                <div class="form-group">
                                    <label class="form-label">Taxa Contratada (%)</label>
                                    <input type="number" step="0.01" class="form-input" id="edit-contractedRate" value="${investment.contractedRate || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Emissor</label>
                                    <input type="text" class="form-input" id="edit-issuer" value="${investment.issuer || ''}">
                                </div>
                            `}
                        </div>
                        <div class="edit-actions">
                            <button class="btn btn-sm btn-success" onclick="saveInvestmentEdit('${investment.id}', ${portfolioId})">
                                ‚úÖ Salvar
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelEdit()">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function handleEditLiquidityChange() {
            const select = document.getElementById('edit-liquidity');
            const customInput = document.getElementById('edit-custom-liquidity');
            if (select.value === 'custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
        }

        function editInvestment(investmentId, portfolioId) {
            const portfolio = portfoliosData.find(p => p.id === portfolioId);
            const investment = portfolio.investments.find(i => i.id === investmentId);
            editingInvestment = investment;
            generatePortfoliosList();
        }

        function saveInvestmentEdit(investmentId, portfolioId) {
            const portfolio = portfoliosData.find(p => p.id === portfolioId);
            const investment = portfolio.investments.find(i => i.id === investmentId);
            
            // Update investment data
            investment.name = document.getElementById('edit-name').value;
            investment.currentValue = parseFloat(document.getElementById('edit-currentValue').value);
            investment.acquisitionValue = parseFloat(document.getElementById('edit-acquisitionValue').value);
            
            const liquiditySelect = document.getElementById('edit-liquidity');
            if (liquiditySelect.value === 'custom') {
                investment.liquidity = document.getElementById('edit-liquidity-custom').value;
            } else {
                investment.liquidity = liquiditySelect.value;
            }
            
            if (investment.type === 'fundo') {
                investment.cnpj = document.getElementById('edit-cnpj').value;
                investment.adminFee = parseFloat(document.getElementById('edit-adminFee').value) || null;
            } else {
                investment.contractedRate = parseFloat(document.getElementById('edit-contractedRate').value) || null;
                investment.issuer = document.getElementById('edit-issuer').value;
            }
            
            editingInvestment = null;
            generatePortfoliosList();
            showNotification('‚úÖ Investimento atualizado com sucesso!');
            updateIncompleteCount();
        }

        function cancelEdit() {
            editingInvestment = null;
            generatePortfoliosList();
        }

        // Generate incomplete investments list
        function generateIncompleteList() {
            const container = document.getElementById('incompleteList');
            container.innerHTML = '';

            const incompleteInvestments = [];
            
            portfoliosData.forEach(portfolio => {
                portfolio.investments.forEach(investment => {
                    const missing = [];
                    if (!investment.acquisitionDate) missing.push('acquisitionDate');
                    if (!investment.liquidity) missing.push('liquidity');
                    
                    if (investment.type === 'fundo') {
                        if (!investment.cnpj) missing.push('cnpj');
                        if (!investment.adminFee) missing.push('adminFee');
                        if (!investment.fundType) missing.push('fundType');
                    } else {
                        if (!investment.contractedRate) missing.push('contractedRate');
                        if (!investment.issuer) missing.push('issuer');
                    }
                    
                    if (!investment.monthlyReturn) missing.push('monthlyReturn');
                    if (!investment.yearlyReturn) missing.push('yearlyReturn');
                    
                    if (missing.length > 0) {
                        incompleteInvestments.push({
                            ...investment,
                            portfolioId: portfolio.id,
                            portfolioName: portfolio.name,
                            missingFields: missing
                        });
                    }
                });
            });

            incompleteInvestments.forEach((investment, index) => {
                const incompleteCard = document.createElement('div');
                incompleteCard.className = 'incomplete-item';
                
                const missingFieldsLabels = {
                    acquisitionDate: 'Data de Aquisi√ß√£o',
                    contractedRate: 'Taxa Contratada',
                    issuer: 'Emissor',
                    liquidity: 'Prazo de Liquidez',
                    monthlyReturn: 'Retorno Mensal',
                    yearlyReturn: 'Retorno 12 Meses',
                    cnpj: 'CNPJ do Fundo',
                    adminFee: 'Taxa de Administra√ß√£o',
                    fundType: 'Tipo de Fundo'
                };

                incompleteCard.innerHTML = `
                    <div class="incomplete-header">
                        <div class="incomplete-info">
                            <h4>${investment.name}</h4>
                            <div class="portfolio-name">${investment.portfolioName}</div>
                            <div class="missing-fields">
                                Faltam: ${investment.missingFields.map(field => missingFieldsLabels[field]).join(', ')}
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="toggleIncompleteForm(${index})">
                            Completar Dados
                        </button>
                    </div>
                    <div class="incomplete-form" id="incomplete-form-${index}">
                        <div class="form-grid">
                            ${investment.missingFields.map(field => `
                                <div class="form-group">
                                    <label class="form-label">${missingFieldsLabels[field]}</label>
                                    ${getFieldInput(field, `incomplete-${investment.id}-${field}`, investment)}
                                </div>
                            `).join('')}
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-save" onclick="saveIncompleteData(${index}, '${investment.id}', ${investment.portfolioId})">
                                ‚úÖ Salvar Dados
                            </button>
                            <button class="btn btn-skip" onclick="toggleIncompleteForm(${index})">
                                Pular Este
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(incompleteCard);
            });
        }

        function getFieldInput(field, id, investment) {
            switch (field) {
                case 'acquisitionDate':
                    return `<input type="date" class="form-input" id="${id}">`;
                case 'contractedRate':
                    return `<input type="number" step="0.01" placeholder="10.50" class="form-input" id="${id}">`;
                case 'adminFee':
                    return `<input type="number" step="0.01" placeholder="2.00" class="form-input" id="${id}">`;
                case 'liquidity':
                    return `
                        <select class="form-select" id="${id}" onchange="handleLiquidityChange('${id}')">
                            <option value="">Selecione...</option>
                            <option value="D+0">D+0 (Liquidez imediata)</option>
                            <option value="D+1">D+1 (1 dia √∫til)</option>
                            <option value="D+30">D+30 (30 dias)</option>
                            <option value="D+60">D+60 (60 dias)</option>
                            <option value="D+90">D+90 (90 dias)</option>
                            <option value="D+180">D+180 (180 dias)</option>
                            <option value="D+360">D+360 (360 dias)</option>
                            <option value="custom">Customizar...</option>
                        </select>
                        <div class="custom-liquidity" id="${id}-custom" style="display: none;">
                            <input type="text" class="form-input" id="${id}-custom-value" placeholder="Ex: D+45">
                        </div>
                    `;
                case 'fundType':
                    return `
                        <select class="form-select" id="${id}">
                            <option value="">Selecione...</option>
                            <option value="multimercado">Multimercado</option>
                            <option value="renda-fixa">Renda Fixa</option>
                            <option value="acoes">A√ß√µes</option>
                            <option value="fii">FII</option>
                            <option value="etf">ETF</option>
                            <option value="cambial">Cambial</option>
                            <option value="previdencia">Previd√™ncia</option>
                        </select>
                    `;
                case 'cnpj':
                    return `<input type="text" class="form-input" id="${id}" placeholder="00.000.000/0000-00">`;
                case 'monthlyReturn':
                case 'yearlyReturn':
                    return `<input type="number" step="0.01" placeholder="1.25" class="form-input" id="${id}">`;
                default:
                    return `<input type="text" class="form-input" id="${id}">`;
            }
        }

        function handleLiquidityChange(fieldId) {
            const select = document.getElementById(fieldId);
            const customDiv = document.getElementById(`${fieldId}-custom`);
            if (select.value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
            }
        }

        function toggleIncompleteForm(index) {
            const form = document.getElementById(`incomplete-form-${index}`);
            form.classList.toggle('active');
        }

        function saveIncompleteData(index, investmentId, portfolioId) {
            const portfolio = portfoliosData.find(p => p.id === portfolioId);
            const investment = portfolio.investments.find(i => i.id === investmentId);
            
            // Get all missing fields and update
            const fields = ['acquisitionDate', 'contractedRate', 'issuer', 'liquidity', 'monthlyReturn', 'yearlyReturn', 'cnpj', 'adminFee', 'fundType'];
            
            fields.forEach(field => {
                const input = document.getElementById(`incomplete-${investmentId}-${field}`);
                if (input) {
                    if (field === 'liquidity') {
                        if (input.value === 'custom') {
                            const customValue = document.getElementById(`incomplete-${investmentId}-${field}-custom-value`);
                            investment[field] = customValue.value;
                        } else {
                            investment[field] = input.value;
                        }
                    } else if (['contractedRate', 'monthlyReturn', 'yearlyReturn', 'adminFee'].includes(field)) {
                        investment[field] = parseFloat(input.value) || null;
                    } else {
                        investment[field] = input.value;
                    }
                }
            });
            
            showNotification(`‚úÖ Dados salvos para ${investment.name}`);
            toggleIncompleteForm(index);
            updateIncompleteCount();
            generateIncompleteList();
        }

        function updateIncompleteCount() {
            let count = 0;
            portfoliosData.forEach(portfolio => {
                portfolio.investments.forEach(investment => {
                    const missing = [];
                    if (!investment.acquisitionDate) missing.push(1);
                    if (!investment.liquidity) missing.push(1);
                    if (investment.type === 'fundo') {
                        if (!investment.cnpj) missing.push(1);
                    } else {
                        if (!investment.contractedRate) missing.push(1);
                        if (!investment.issuer) missing.push(1);
                    }
                    if (missing.length > 0) count++;
                });
            });
            
            document.getElementById('incompleteBadge').textContent = count;
        }

        // Asset type selection
        function selectAssetType(type) {
            currentAssetType = type;
            
            // Update UI
            document.querySelectorAll('.asset-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`type-${type}`).classList.add('selected');
            
            // Show form
            const formContainer = document.getElementById('investment-form');
            formContainer.style.display = 'block';
            formContainer.innerHTML = generateInvestmentForm(type);
        }

        function generateInvestmentForm(type) {
            if (type === 'fundo') {
                return `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nome do Fundo <span class="required">*</span></label>
                            <input type="text" class="form-input" id="fund-name" placeholder="Ex: Fundo Multimercado XP">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CNPJ do Fundo</label>
                            <input type="text" class="form-input" id="fund-cnpj" placeholder="00.000.000/0000-00">
                            <div class="form-hint">Para atualiza√ß√£o autom√°tica de cotas</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Fundo <span class="required">*</span></label>
                            <select class="form-select" id="fund-type">
                                <option value="">Selecione...</option>
                                <option value="multimercado">Multimercado</option>
                                <option value="renda-fixa">Renda Fixa</option>
                                <option value="acoes">A√ß√µes</option>
                                <option value="fii">FII - Fundos Imobili√°rios</option>
                                <option value="etf">ETF - Exchange Traded Fund</option>
                                <option value="cambial">Cambial</option>
                                <option value="previdencia">Previd√™ncia Privada</option>
                                <option value="credito-privado">Cr√©dito Privado</option>
                                <option value="infraestrutura">Infraestrutura</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Taxa de Administra√ß√£o (% a.a.)</label>
                            <input type="number" step="0.01" class="form-input" id="fund-admin-fee" placeholder="2.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantidade de Cotas <span class="required">*</span></label>
                            <input type="number" step="0.01" class="form-input" id="fund-quantity" placeholder="1000.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor da Cota na Compra <span class="required">*</span></label>
                            <input type="number" step="0.0001" class="form-input" id="fund-quote-value" placeholder="10.0000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data da Aplica√ß√£o <span class="required">*</span></label>
                            <input type="date" class="form-input" id="fund-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prazo de Liquidez <span class="required">*</span></label>
                            <select class="form-select" id="fund-liquidity" onchange="handleNewLiquidityChange()">
                                <option value="">Selecione...</option>
                                <option value="D+0">D+0 (Liquidez imediata)</option>
                                <option value="D+1">D+1 (1 dia √∫til)</option>
                                <option value="D+30">D+30 (30 dias)</option>
                                <option value="D+60">D+60 (60 dias)</option>
                                <option value="D+90">D+90 (90 dias)</option>
                                <option value="custom">Customizar...</option>
                            </select>
                            <div class="custom-liquidity" id="new-custom-liquidity">
                                <input type="text" class="form-input" id="fund-liquidity-custom" placeholder="Ex: D+15">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Carteira <span class="required">*</span></label>
                            <select class="form-select" id="fund-portfolio">
                                ${portfoliosData.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="cancelNewInvestment()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveFundInvestment()">
                            üíæ Salvar Fundo
                        </button>
                    </div>
                `;
            } else {
                return `
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Tipo de T√≠tulo <span class="required">*</span></label>
                            <select class="form-select" id="title-type">
                                <option value="">Selecione...</option>
                                <option value="CDB">CDB</option>
                                <option value="LCI">LCI</option>
                                <option value="LCA">LCA</option>
                                <option value="LC">LC (Letra de C√¢mbio)</option>
                                <option value="Tesouro">Tesouro Direto</option>
                                <option value="Debenture">Deb√™nture</option>
                                <option value="CRI">CRI</option>
                                <option value="CRA">CRA</option>
                                <option value="COE">COE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome/Descri√ß√£o <span class="required">*</span></label>
                            <input type="text" class="form-input" id="title-name" placeholder="Ex: CDB Banco X 2025">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Emissor <span class="required">*</span></label>
                            <input type="text" class="form-input" id="title-issuer" placeholder="Ex: Banco X">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor Investido <span class="required">*</span></label>
                            <input type="number" step="0.01" class="form-input" id="title-value" placeholder="10000.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Taxa Contratada (%) <span class="required">*</span></label>
                            <input type="number" step="0.01" class="form-input" id="title-rate" placeholder="102.50">
                            <div class="form-hint">Percentual do CDI ou taxa prefixada</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Indexador</label>
                            <select class="form-select" id="title-indexer">
                                <option value="CDI">% CDI</option>
                                <option value="IPCA">IPCA +</option>
                                <option value="Prefixado">Prefixado</option>
                                <option value="Selic">Selic</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de Aquisi√ß√£o <span class="required">*</span></label>
                            <input type="date" class="form-input" id="title-date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="date" class="form-input" id="title-maturity">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prazo de Liquidez <span class="required">*</span></label>
                            <select class="form-select" id="title-liquidity" onchange="handleNewLiquidityChange()">
                                <option value="">Selecione...</option>
                                <option value="D+0">D+0 (Liquidez imediata)</option>
                                <option value="D+1">D+1 (1 dia √∫til)</option>
                                <option value="D+30">D+30 (30 dias)</option>
                                <option value="D+60">D+60 (60 dias)</option>
                                <option value="D+90">D+90 (90 dias)</option>
                                <option value="D+180">D+180 (180 dias)</option>
                                <option value="D+360">D+360 (360 dias)</option>
                                <option value="custom">Customizar...</option>
                            </select>
                            <div class="custom-liquidity" id="new-custom-liquidity">
                                <input type="text" class="form-input" id="title-liquidity-custom" placeholder="Ex: D+45">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Carteira <span class="required">*</span></label>
                            <select class="form-select" id="title-portfolio">
                                ${portfoliosData.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" onclick="cancelNewInvestment()">Cancelar</button>
                        <button class="btn btn-primary" onclick="saveTitleInvestment()">
                            üíæ Salvar T√≠tulo
                        </button>
                    </div>
                `;
            }
        }

        function handleNewLiquidityChange() {
            const select = document.getElementById(currentAssetType === 'fundo' ? 'fund-liquidity' : 'title-liquidity');
            const customDiv = document.getElementById('new-custom-liquidity');
            if (select.value === 'custom') {
                customDiv.classList.add('active');
            } else {
                customDiv.classList.remove('active');
            }
        }

        function saveFundInvestment() {
            const name = document.getElementById('fund-name').value;
            const cnpj = document.getElementById('fund-cnpj').value;
            const fundType = document.getElementById('fund-type').value;
            const adminFee = parseFloat(document.getElementById('fund-admin-fee').value) || null;
            const quantity = parseFloat(document.getElementById('fund-quantity').value);
            const quoteValue = parseFloat(document.getElementById('fund-quote-value').value);
            const date = document.getElementById('fund-date').value;
            const liquiditySelect = document.getElementById('fund-liquidity');
            const liquidity = liquiditySelect.value === 'custom' ? 
                document.getElementById('fund-liquidity-custom').value : liquiditySelect.value;
            const portfolioId = parseInt(document.getElementById('fund-portfolio').value);
            
            if (!name || !fundType || !quantity || !quoteValue || !date || !liquidity || !portfolioId) {
                showNotification('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }
            
            const portfolio = portfoliosData.find(p => p.id === portfolioId);
            const newInvestment = {
                id: `FUND${Date.now()}`,
                name: name,
                category: 'Fundos',
                type: 'fundo',
                currentValue: quantity * quoteValue,
                acquisitionValue: quantity * quoteValue,
                monthlyReturn: null,
                yearlyReturn: null,
                acquisitionDate: date,
                contractedRate: null,
                issuer: null,
                liquidity: liquidity,
                cnpj: cnpj,
                fundType: fundType,
                adminFee: adminFee,
                quantity: quantity,
                currentQuote: quoteValue
            };
            
            portfolio.investments.push(newInvestment);
            
            showNotification('‚úÖ Fundo de investimento adicionado com sucesso!');
            cancelNewInvestment();
            updateIncompleteCount();
            updateDashboardMetrics();
        }

        function saveTitleInvestment() {
            const titleType = document.getElementById('title-type').value;
            const name = document.getElementById('title-name').value;
            const issuer = document.getElementById('title-issuer').value;
            const value = parseFloat(document.getElementById('title-value').value);
            const rate = parseFloat(document.getElementById('title-rate').value);
            const indexer = document.getElementById('title-indexer').value;
            const date = document.getElementById('title-date').value;
            const maturity = document.getElementById('title-maturity').value;
            const liquiditySelect = document.getElementById('title-liquidity');
            const liquidity = liquiditySelect.value === 'custom' ? 
                document.getElementById('title-liquidity-custom').value : liquiditySelect.value;
            const portfolioId = parseInt(document.getElementById('title-portfolio').value);
            
            if (!titleType || !name || !issuer || !value || !rate || !date || !liquidity || !portfolioId) {
                showNotification('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }
            
            const portfolio = portfoliosData.find(p => p.id === portfolioId);
            const newInvestment = {
                id: `${titleType}${Date.now()}`,
                name: name,
                category: 'RF',
                type: 'titulo',
                currentValue: value,
                acquisitionValue: value,
                monthlyReturn: null,
                yearlyReturn: null,
                acquisitionDate: date,
                contractedRate: rate,
                issuer: issuer,
                liquidity: liquidity,
                titleType: titleType,
                indexer: indexer,
                maturity: maturity
            };
            
            portfolio.investments.push(newInvestment);
            
            showNotification('‚úÖ T√≠tulo adicionado com sucesso!');
            cancelNewInvestment();
            updateIncompleteCount();
            updateDashboardMetrics();
        }

        function cancelNewInvestment() {
            document.getElementById('investment-form').style.display = 'none';
            document.getElementById('investment-form').innerHTML = '';
            document.querySelectorAll('.asset-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            currentAssetType = null;
        }

        // Update dashboard metrics
        function updateDashboardMetrics() {
            let totalValue = 0;
            let rfValue = 0;
            let avValue = 0;
            let fundValue = 0;
            let immediateValue = 0;
            let fundsCount = 0;
            
            portfoliosData.forEach(portfolio => {
                portfolio.investments.forEach(inv => {
                    totalValue += inv.currentValue;
                    
                    if (inv.category === 'RF') rfValue += inv.currentValue;
                    else if (inv.category === 'AV') avValue += inv.currentValue;
                    else if (inv.category === 'Fundos') fundValue += inv.currentValue;
                    
                    if (inv.liquidity === 'D+0' || inv.liquidity === 'D+1') {
                        immediateValue += inv.currentValue;
                    }
                    
                    if (inv.type === 'fundo') fundsCount++;
                });
            });
            
            // Update insights
            document.getElementById('liquidity-immediate').textContent = `${((immediateValue / totalValue) * 100).toFixed(1)}%`;
            document.getElementById('concentration-rf').textContent = `${((rfValue / totalValue) * 100).toFixed(1)}%`;
            document.getElementById('active-funds').textContent = fundsCount.toString();
            
            // Update allocation chart
            if (allocationChart) {
                allocationChart.data.datasets[0].data = [
                    ((rfValue / totalValue) * 100).toFixed(1),
                    ((avValue / totalValue) * 100).toFixed(1),
                    ((fundValue / totalValue) * 100).toFixed(1)
                ];
                allocationChart.update();
            }
        }

        // Navigation and control functions
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            if (tabName === 'portfolios') {
                generatePortfoliosList();
            } else if (tabName === 'complete') {
                generateIncompleteList();
            }

            showNotification(`üìÑ Aba alterada: ${getTabName(tabName)}`);
        }

        function getTabName(tabId) {
            const names = {
                dashboard: 'Dashboard',
                portfolios: 'Carteiras',
                complete: 'Completar Dados',
                add: 'Adicionar Investimento',
                settings: 'Configura√ß√µes'
            };
            return names[tabId] || tabId;
        }

function toggleValues() {
            showValuesState = !showValuesState;
            const icon = document.getElementById('toggle-icon');
            const text = document.getElementById('toggle-text');
            
            if (showValuesState) {
                icon.textContent = 'üôà';
                text.textContent = 'Ocultar';
                document.querySelectorAll('.portfolio-total, .investment-amount, .kpi-value').forEach(el => {
                    el.style.filter = 'none';
                });
            } else {
                icon.textContent = 'üëÅÔ∏è';
                text.textContent = 'Mostrar';
                document.querySelectorAll('.portfolio-total, .investment-amount, .kpi-value').forEach(el => {
                    el.style.filter = 'blur(8px)';
                });
            }
            
            showNotification(`üëÅÔ∏è Visibilidade dos valores ${showValuesState ? 'ativada' : 'desativada'}`);
        }
        function setPeriod(months, button) {
            currentPeriod = months;
            
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            document.getElementById('period-display').textContent = months;
            
            updatePerformanceData();
            updatePerformanceChart();
            showNotification(`üìä Per√≠odo alterado para ${months} meses`);
        }

        function setPortfolio(value) {
            currentPortfolio = value;
            document.getElementById('portfolio-display').textContent = portfolioNames[value];
            
            updatePerformanceData();
            updatePerformanceChart();
            showNotification(`üè¶ Carteira alterada: ${portfolioNames[value]}`);
        }

        function updatePerformanceData() {
            const data = performanceData[currentPeriod][currentPortfolio];
            
            document.getElementById('portfolio-perf').textContent = `+${data.portfolio}%`;
            document.getElementById('cdi-perf').textContent = `+${data.cdi}%`;
            document.getElementById('ibov-perf').textContent = `+${data.ibov}%`;
            document.getElementById('ipca-perf').textContent = `+${data.ipca}%`;
        }

        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            notification.className = 'notification ' + type;
            document.getElementById('notif-text').textContent = text;
            notification.classList.add('show');
            setTimeout(() => hideNotification(), 4000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        // Initialize everything
        window.addEventListener('load', function() {
            initCharts();
            updatePerformanceData();
            updateIncompleteCount();
            updateDashboardMetrics();
            setTimeout(() => {
                showNotification('üéâ Portfolio PWA v2.0 - Sistema aprimorado com suporte a fundos!');
            }, 500);
        });
    </script>
</body>
</html>

